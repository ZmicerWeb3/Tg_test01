<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Sum App</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f0f0f0; }
        h1 { text-align: center; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #555; }
        input, select { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        button:hover { background-color: #0056b3; }
        #timer { font-size: 24px; margin: 20px 0; text-align: center; color: #333; }
        #timeList { margin-top: 20px; }
        .time-entry { padding: 10px; background-color: #f9f9f9; margin-bottom: 10px; border-radius: 4px; }
        .date-group { margin-bottom: 20px; }
        .date-header { font-weight: bold; color: #007bff; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Time Sum App</h1>
        <div class="input-group">
            <label for="dateInput">Date:</label>
            <input type="date" id="dateInput">
        </div>
        <div class="input-group">
            <label for="timeInput">Minutes:</label>
            <input type="number" id="timeInput" min="0">
        </div>
        <div class="input-group">
            <label for="labelInput">Label:</label>
            <select id="labelInput">
                <option value="Сон">Сон</option>
                <option value="Кормление">Кормление</option>
                <option value="Игра">Игра</option>
                <option value="Прогулка">Прогулка</option>
                <option value="Другое">Другое</option>
            </select>
        </div>
        <button onclick="addTime()">Add Time</button>
        <button onclick="startTimer()">Start Timer</button>
        <button onclick="stopTimer()">Stop Timer</button>
        <button onclick="resetAll()">Reset All</button>
        <div id="timer">00:00</div>
        <div id="timeList"></div>
    </div>

    <script>
        let timesByDate = {};
        let timerSeconds = 0;
        let timerInterval = null;
        const BASE_URL = "https://eba4-109-123-246-190.ngrok-free.app"; // Новый URL от ngrok

        window.Telegram.WebApp.ready();

        document.addEventListener("DOMContentLoaded", () => {
            setDefaultDate();
            fetchTimesFromServer();
        });

        function setDefaultDate() {
            const today = new Date().toISOString().split("T")[0];
            document.getElementById("dateInput").value = today;
        }

        function addTime() {
            const date = document.getElementById("dateInput").value;
            const minutes = parseInt(document.getElementById("timeInput").value);
            const label = document.getElementById("labelInput").value;

            if (!date || isNaN(minutes) || minutes <= 0) {
                alert("Please enter a valid date and minutes!");
                return;
            }

            saveToServer(date, minutes, label);
        }

        function saveToServer(date, minutes, label) {
            console.log("Saving to server:", { date, minutes, label });
            fetch(`${BASE_URL}/save-time`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "ngrok-skip-browser-warning": "true" // Обход предупреждения ngrok
                },
                body: JSON.stringify({ date, minutes, label })
            })
            .then(response => {
                console.log("Save response status:", response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`HTTP error! Status: ${response.status}, Response: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log("Save response data:", data);
                document.getElementById("timeInput").value = "";
                fetchTimesFromServer();
            })
            .catch(err => {
                console.error("Error saving to server:", err);
                alert("Failed to save data. Check console for details.");
            });
        }

        function fetchTimesFromServer() {
            console.log("Fetching times from server...");
            fetch(`${BASE_URL}/get-times`, {
                method: "GET",
                headers: {
                    "Accept": "application/json",
                    "ngrok-skip-browser-warning": "true" // Обход предупреждения ngrok
                }
            })
            .then(response => {
                console.log("Fetch response status:", response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`HTTP error! Status: ${response.status}, Response: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log("Fetched data:", data);
                timesByDate = {};
                data.forEach(record => {
                    if (!timesByDate[record.date]) timesByDate[record.date] = [];
                    timesByDate[record.date].push({ minutes: record.minutes, label: record.label });
                });
                updateTimeList();
            })
            .catch(err => {
                console.error("Error fetching from server:", err);
                alert("Failed to load data. Check console for details.");
            });
        }

        function updateTimeList() {
            const timeList = document.getElementById("timeList");
            timeList.innerHTML = "";
            for (const date in timesByDate) {
                const dateGroup = document.createElement("div");
                dateGroup.className = "date-group";

                const dateHeader = document.createElement("div");
                dateHeader.className = "date-header";
                dateHeader.textContent = `${date} (Total: ${timesByDate[date].reduce((sum, entry) => sum + entry.minutes, 0)} minutes)`;
                dateGroup.appendChild(dateHeader);

                timesByDate[date].forEach(entry => {
                    const entryDiv = document.createElement("div");
                    entryDiv.className = "time-entry";
                    entryDiv.textContent = `${entry.minutes} minutes - ${entry.label}`;
                    dateGroup.appendChild(entryDiv);
                });

                timeList.appendChild(dateGroup);
            }
        }

        function startTimer() {
            if (!timerInterval) {
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    updateTimerDisplay();
                }, 1000);
            }
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;

                const date = document.getElementById("dateInput").value;
                const minutes = Math.floor(timerSeconds / 60);
                const label = document.getElementById("labelInput").value;

                if (minutes > 0) {
                    saveToServer(date, minutes, label);
                }

                timerSeconds = 0;
                updateTimerDisplay();
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            document.getElementById("timer").textContent = `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
        }

        function resetAll() {
            console.log("Resetting all data...");
            fetch(`${BASE_URL}/reset`, {
                method: "POST",
                headers: {
                    "ngrok-skip-browser-warning": "true" // Обход предупреждения ngrok
                }
            })
            .then(response => {
                console.log("Reset response status:", response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`HTTP error! Status: ${response.status}, Response: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log("Reset response data:", data);
                timesByDate = {};
                updateTimeList();
                timerSeconds = 0;
                updateTimerDisplay();
            })
            .catch(err => {
                console.error("Error resetting data:", err);
                alert("Failed to reset data. Check console for details.");
            });
        }
    </script>
</body>
</html>
