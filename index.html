<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сумма времени</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f0f0f0; }
        input, button, select { margin: 5px 0; padding: 8px; width: 100%; }
        #timerDisplay { font-size: 1.2em; color: #333; }
        .day-section { margin-top: 10px; }
    </style>
</head>
<body>
    <h2>Введи время (чч:мм)</h2>
    <input type="text" id="timeInput" placeholder="Например, 02:30">
    <select id="labelSelect">
        <option value="Общее">Общее</option>
        <option value="Сон">Сон</option>
    </select>
    <button onclick="addTime()">Добавить</button>
    <button onclick="startTimer()">Старт</button>
    <button onclick="stopTimer()" disabled>Стоп</button>
    <button onclick="editTime()">Редактировать</button>
    <button onclick="resetAll()">Сбросить все данные</button>
    <p>Таймер: <span id="timerDisplay">00:00</span></p>
    <div id="timeList"></div>

    <script>
        let timesByDate = JSON.parse(localStorage.getItem("timesByDate")) || {};
        let timerInterval = null;
        let timerSeconds = 0;

        window.Telegram.WebApp.ready();
        Telegram.WebApp.MainButton.hide();

        window.onload = function() {
            updateTimeList();
        };

        // Форматирование даты в YYYY-MM-DD
        function getCurrentDate() {
            const now = new Date();
            return now.toISOString().split("T")[0];
        }

        // Добавление времени вручную
        function addTime() {
            const input = document.getElementById("timeInput").value;
            const label = document.getElementById("labelSelect").value;
            const regex = /^([0-1]?[0-9]|2[0-3]):([0-5][0-9])$/;
            if (regex.test(input)) {
                const [hours, minutes] = input.split(":").map(Number);
                const totalMinutes = hours * 60 + minutes;
                const date = getCurrentDate();
                if (!timesByDate[date]) timesByDate[date] = [];
                timesByDate[date].push({ minutes: totalMinutes, label });
                saveAndUpdate();
                document.getElementById("timeInput").value = "";
            } else {
                alert("Введите время в формате чч:мм (например, 02:30)");
            }
        }

        // Старт таймера
        function startTimer() {
            if (!timerInterval) {
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    updateTimerDisplay();
                }, 1000);
                document.querySelector("button[onclick='startTimer()']").disabled = true;
                document.querySelector("button[onclick='stopTimer()']").disabled = false;
            }
        }

        // Стоп таймера и запись времени
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                const totalMinutes = Math.floor(timerSeconds / 60);
                timerSeconds = 0;
                updateTimerDisplay();
                const date = getCurrentDate();
                const label = document.getElementById("labelSelect").value;
                if (!timesByDate[date]) timesByDate[date] = [];
                timesByDate[date].push({ minutes: totalMinutes, label });
                saveAndUpdate();
                document.querySelector("button[onclick='startTimer()']").disabled = false;
                document.querySelector("button[onclick='stopTimer()']").disabled = true;
            }
        }

        // Обновление отображения таймера
        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60).toString().padStart(2, "0");
            const seconds = (timerSeconds % 60).toString().padStart(2, "0");
            document.getElementById("timerDisplay").innerText = `${minutes}:${seconds}`;
        }

        // Редактирование времени
        function editTime() {
            const date = prompt("Введите дату для редактирования (YYYY-MM-DD):", getCurrentDate());
            if (!timesByDate[date]) return alert("Нет данных за эту дату.");
            const times = timesByDate[date];
            const index = prompt(`Выберите запись для редактирования (0-${times.length - 1}):\n${times.map((t, i) => `${i}: ${formatMinutes(t.minutes)} (${t.label})`).join("\n")}`);
            if (index !== null && times[index]) {
                const newTime = prompt("Введите новое время (чч:мм):", formatMinutes(times[index].minutes));
                const regex = /^([0-1]?[0-9]|2[0-3]):([0-5][0-9])$/;
                if (regex.test(newTime)) {
                    const [hours, minutes] = newTime.split(":").map(Number);
                    times[index].minutes = hours * 60 + minutes;
                    saveAndUpdate();
                } else {
                    alert("Неверный формат времени.");
                }
            }
        }

        // Сохранение и обновление списка
        function saveAndUpdate() {
            localStorage.setItem("timesByDate", JSON.stringify(timesByDate));
            updateTimeList();
        }

        // Обновление списка времён по дням
        function updateTimeList() {
            const container = document.getElementById("timeList");
            container.innerHTML = "";
            for (const date in timesByDate) {
                const times = timesByDate[date];
                const totalMinutes = times.reduce((sum, t) => sum + t.minutes, 0);
                const hours = Math.floor(totalMinutes / 60).toString().padStart(2, "0");
                const minutes = (totalMinutes % 60).toString().padStart(2, "0");
                const div = document.createElement("div");
                div.className = "day-section";
                div.innerHTML = `
                    <h3>${date} (Сумма: ${hours}:${minutes})</h3>
                    <p>${times.map(t => `${formatMinutes(t.minutes)} (${t.label})`).join(", ")}</p>
                `;
                container.appendChild(div);
            }
        }

        // Форматирование минут в чч:мм
        function formatMinutes(mins) {
            const h = Math.floor(mins / 60).toString().padStart(2, "0");
            const m = (mins % 60).toString().padStart(2, "0");
            return `${h}:${m}`;
        }

        // Сброс всех данных
        function resetAll() {
            timesByDate = {};
            localStorage.removeItem("timesByDate");
            updateTimeList();
            timerSeconds = 0;
            updateTimerDisplay();
        }
    </script>
</body>
</html>
